webpackJsonp([5],{1214:function(e,t,n){n(169),e.exports=n(395)},253:function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function s(e,t){return new u(e,t).getState()}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),l=function e(t,n,a){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,n);if(void 0===o){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,n,a)}if("value"in o)return o.value;var s=o.get;if(void 0!==s)return s.call(a)};t.getState=s;var c=n(44),u=function(e){function t(){return a(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),i(t,[{key:"getState",value:function(){return l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"getState",this).call(this),this.uploadedPhotos=[],this.signedPhotos=[],this.isSubmitting=!1,this.isUploading=!1,this.isModalOpen=!1,this.templatesObj={},this.templatesArr=[],this.message="",this.cursorPosition=0,this.error=null,this}}]),t}(c.AppState);t.default=u},395:function(e,t,n){"use strict";(function(e){function t(e){return e&&e.__esModule?e:{default:e}}var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e};n(57);var o=n(115);t(o);n(149);var r=n(2),s=t(r),i=n(19),l=t(i),c=n(21),u=t(c),p=(n(44),n(5)),d=n(253),m=n(421),f=t(m),h=n(419);!function(e,t){var n=t.querySelector(".js-new-message"),o=new u.default.Subject,r=e.AppData=(0,d.getState)(e,t),i=[o.filter((0,p.actionIs)("formSubmitClick")).map(h.formSubmitClick),o.filter((0,p.actionIs)("formSubmitResultReceived")).map(h.formSubmitResultReceived),o.filter((0,p.actionIs)("handlePhotoUpload")).map(h.handlePhotoUpload),o.filter((0,p.actionIs)("additionalPhotoAdded")).map(h.additionalPhotoAdded),o.filter((0,p.actionIs)("errorCaught")).map(h.errorCaught),o.filter((0,p.actionIs)("templatesModalOpen")).map(h.templatesModalOpen),o.filter((0,p.actionIs)("templatesResponseReceived")).map(h.templatesResponseReceived),o.filter((0,p.actionIs)("templateSelected")).map(h.templateSelected),o.filter((0,p.actionIs)("closeClicked")).map(h.closeClicked),o.filter((0,p.actionIs)("toggleThreadImportance")).map(h.toggleThreadImportance),o.filter((0,p.actionIs)("toggleThreadImportanceResponseReceived")).map(h.toggleThreadImportanceResponseReceived)];if(n){var c;(c=u.default.Observable).merge.apply(c,i).scan(function(e,t){return t(e)},r).startWith(r).subscribe(function(e){l.default.render(s.default.createElement(f.default,a({eventStream:o},e)),n)})}}(window,document),function(){e(".js-collapse-trigger").click(function(t){t.preventDefault();var n=e(this),a=n.data("collapseText"),o=n.data("expandText"),r=n.next();r.slideToggle(500,function(){n.text(function(){return r.is(":visible")?o:a})})}),e(".js-lazy-img").lazyLoadXT();var t=e(".js-gallery-magnific");t.length&&t.magnificPopup({delegate:".js-gallery-magnific-item",type:"image",tClose:"Закрыть",tLoading:"Загрузка...",gallery:{enabled:!0,preload:[0,2],navigateByImgClick:!0,tPrev:"Предыдущее фото",tNext:"Следующее фото",tCounter:'<span class="mfp-counter">%curr% из %total%</span>'},image:{tError:"Нет фото"},zoom:{enabled:!0,duration:200,easing:"ease-in-out"}})}()}).call(t,n(39))},419:function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function o(e){var t=e.eventStream,n=e.config,a=e.parent,o=e.text,r=e.photos;return g.default.post(n.submitUrl).type("form").send({csrfmiddlewaretoken:n.csrfToken}).send({parent:a}).send({body:o}).send({photos:r}).end(function(e,n){n&&n.ok?t.next({action:"formSubmitResultReceived",response:n}):t.next({action:"errorCaught",error:"Что-то пошло не так, попробуйте повторить позже"})}),function(e){return e.isSubmitting=!0,e}}function r(e){var t=e.response;return function(e){if(t&&t.ok&&t.body)if(t.body.success)window.location.href=window.location.pathname+"?r="+Math.random()+"#last-message";else{var n=t.body.errors;e.error=n.body.pop(),e.isSubmitting=!1}else e.error="Что-то пошло не так, попробуйте повторить позже",e.isSubmitting=!1;return e}}function s(e){var t=e.eventStream,n=e.config,a=e.files,o=e.message;return g.default.post(n.photoUploadUrl).field("csrfmiddlewaretoken",n.csrfToken).attach("photos",a[0]).end(function(e,n){n&&n.ok&&n.body?n.body.success?t.next({action:"additionalPhotoAdded",photos:n.body.photos,signedPhotos:n.body.signed_photos}):t.next({action:"errorCaught",error:n.body.error}):t.next({action:"errorCaught",error:"Что-то пошло не так, попробуйте повторить позже"})}),function(e){return e.isUploading=!0,e.message=o,e}}function i(e){var t=e.photos,n=e.signedPhotos;return function(e){return e.uploadedPhotos=e.uploadedPhotos.concat(t),e.signedPhotos.push(n),e.isUploading=!1,e}}function l(e){var t=e.eventStream,n=e.config,a=e.message;return g.default.post(n.toggleThreadImportanceUrl).field("csrfmiddlewaretoken",n.csrfToken).set("X-Requested-With","XMLHttpRequest").set("Accept","application/json").end(function(e,n){n&&n.ok&&n.body?n.body.success&&t.next({action:"toggleThreadImportanceResponseReceived"}):t.next({action:"errorCaught",error:"Что-то пошло не так, попробуйте повторить позже"})}),function(e){return e.message=a,e}}function c(){return function(e){return e.dialogIsImportant=!e.dialogIsImportant,e}}function u(e){var t=e.error;return function(e){return e.error=t,e.isUploading=!1,e.isSubmitting=!1,e.isModalOpen=!1,e}}function p(e){var t=e.eventStream,n=e.config,a=e.cursorPosition,o=e.message;return g.default.get(n.messageTemplatesUrl).end(function(e,n){n&&n.body&&n.body.success?t.next({action:"templatesResponseReceived",templates:n.body.templates}):t.next({action:"errorCaught",error:n.body.error})}),function(e){return e.cursorPosition=a,e.message=o,e}}function d(e){var t=e.templates;return function(e){return e.templatesObj=t,e.templatesArr=Object.values(t),e.isModalOpen=!0,e}}function m(e){var t=e.template;return function(e){var n=e.message.substring(0,e.cursorPosition),a=e.message.substring(e.cursorPosition,e.message.length);return e.message=[n,t.body,a].join("").trim(),e.isModalOpen=!1,e}}function f(){return function(e){return e.isModalOpen=!1,e}}Object.defineProperty(t,"__esModule",{value:!0}),t.formSubmitClick=o,t.formSubmitResultReceived=r,t.handlePhotoUpload=s,t.additionalPhotoAdded=i,t.toggleThreadImportance=l,t.toggleThreadImportanceResponseReceived=c,t.errorCaught=u,t.templatesModalOpen=p,t.templatesResponseReceived=d,t.templateSelected=m,t.closeClicked=f;var h=n(68),g=a(h),b=n(253);a(b)},420:function(e,t,n){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=n(2),l=function(e){return e&&e.__esModule?e:{default:e}}(i),c=function(e){function t(e){a(this,t);var n=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.state={templateID:n.props.templatesArr.length&&n.props.templatesArr[0].id},n}return r(t,e),s(t,[{key:"onClose",value:function(){this.props.eventStream.next({action:"closeClicked",eventStream:this.props.eventStream})}},{key:"handleChange",value:function(e){this.setState({templateID:e.currentTarget.value})}},{key:"handleChoice",value:function(e){e.preventDefault(),this.props.eventStream.next({action:"templateSelected",eventStream:this.props.eventStream,template:this.props.templatesObj[this.state.templateID||this.refs.templateID.value]})}},{key:"render",value:function(){var e=this.props.config.messageTemplateAddUrl;return this.props.templatesArr.length>0?l.default.createElement("div",null,l.default.createElement("h4",{className:"b-title b-block"},"Выберите готовый ответ"),l.default.createElement("form",null,l.default.createElement("div",{className:"b-form-row b-modal__inner"},l.default.createElement("ul",{className:"b-simple-list"},this.props.templatesArr.map(function(e){return l.default.createElement("li",{className:"b-simple-list__item",key:e.id},l.default.createElement("input",{ref:"templateID",name:"templateID",value:e.id,id:"radio-"+e.id,type:"radio",className:"b-form-check-input",checked:this.state.templateID==e.id,onChange:this.handleChange.bind(this)}),l.default.createElement("label",{htmlFor:"radio-"+e.id,className:"b-form-radio"},e.title,l.default.createElement("br",null),l.default.createElement("span",{style:{color:"#b8b8b8",marginLeft:"25px"}},e.body.length>25?e.body.slice(0,25)+"...":e.body)))}.bind(this)))),l.default.createElement("button",{className:"b-button-bordered b-button-bordered_lh_24",type:"button",onClick:this.onClose.bind(this)},"Отмена"),l.default.createElement("button",{className:"b-button b-button_pull_right",onClick:this.handleChoice.bind(this)},"Вставить"))):l.default.createElement("div",{className:"b-inline"},l.default.createElement("h4",{className:"b-title"},"У вас нет готовых ответов"),l.default.createElement("p",{className:"b-modal__paragraph"},"Добавьте готовые ответы в ",l.default.createElement("a",{className:"b-link_theme_green",href:e},"настройках"),", чтобы не вводить каждый раз повторяющуюся информацию."),l.default.createElement("button",{className:"b-button b-button_pull_right",onClick:this.onClose.bind(this)},"Закрыть"))}}]),t}(l.default.Component);t.default=c},421:function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},l=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),c=n(2),u=a(c),p=n(19),d=a(p),m=n(63),f=a(m),h=n(14),g=a(h),b=n(420),v=a(b),_=n(5),y=n(170),S=a(y),w=function(e){function t(){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return s(t,e),l(t,[{key:"handleSubmitClick",value:function(e){e.preventDefault(),this.props.eventStream.next({action:"formSubmitClick",eventStream:this.props.eventStream,config:this.props.config,parent:this.props.parent,text:this.refs.msg.value,photos:this.props.signedPhotos})}},{key:"handlePhotoUpload",value:function(e){if(this.props.uploadedPhotos.length>=this.props.config.maxFileCount)return this.props.eventStream.next({action:"errorCaught",error:"Вы можете добавить не более "+this.props.config.maxFileCount+" фото"}),!1;this.props.eventStream.next({action:"handlePhotoUpload",eventStream:this.props.eventStream,config:this.props.config,files:e.currentTarget.files,message:this.refs.msg.value})}},{key:"handlePhotoClick",value:function(e){e.preventDefault(),this.props.eventStream.next({action:"photoChanged",eventStream:this.props.eventStream,photos:this.props.uploadedPhotos,index:parseInt(e.currentTarget.dataset.index)})}},{key:"toggleThreadImportance",value:function(e){this.props.eventStream.next({action:"toggleThreadImportance",eventStream:this.props.eventStream,config:this.props.config,message:this.refs.msg.value})}},{key:"handleTemplatesModalOpen",value:function(e){e.preventDefault(),this.props.eventStream.next({action:"templatesModalOpen",eventStream:this.props.eventStream,config:this.props.config,cursorPosition:this.refs.msg.selectionStart,message:this.refs.msg.value})}},{key:"onClose",value:function(){this.props.eventStream.next({action:"closeClicked",eventStream:this.props.eventStream})}},{key:"componentDidMount",value:function(){(0,S.default)(d.default.findDOMNode(this.refs.msg))}},{key:"componentDidUpdate",value:function(){this.refs.msg.value=this.props.message,S.default.update(d.default.findDOMNode(this.refs.msg))}},{key:"render",value:function(){var e=this;return u.default.createElement("form",{action:"",className:"b-new-message"},u.default.createElement("div",{className:"b-new-message__image-wrapper"},u.default.createElement("img",{src:this.props.user.picture,alt:this.props.user.username.slice(0,4),className:"b-new-message__image"})),u.default.createElement("div",{className:"b-new-message__textfield"},u.default.createElement("textarea",{ref:"msg",className:"b-new-message__textarea",placeholder:"Текст сообщения"}),u.default.createElement("span",{className:"b-new-message__triangle"})),function(){if(e.props.error)return u.default.createElement("div",{className:"b-new-message__error"},e.props.error)}(),u.default.createElement("div",{className:"b-messages b-new-message__upload"},u.default.createElement("ul",{className:"b-messages__photos-list js-gallery-magnific"},this.props.uploadedPhotos.map(function(e,t){return u.default.createElement("li",{className:"b-messages__photos-item",key:e.id},u.default.createElement("a",{href:e.url,target:"_blank",className:"b-messages__photos-link","data-index":t},u.default.createElement("span",{className:"b-messages__photos-wrapper"},u.default.createElement("img",{src:e.url,alt:e.name.slice(0,4),className:"b-messages__photos-image"})),u.default.createElement("span",{className:"b-messages__photos-text"},e.name.slice(0,6))))}))),u.default.createElement("span",{className:(0,g.default)("b-messages__photos-upload-loader",{"b-hidden":!this.props.isUploading})},u.default.createElement("img",{src:(0,_.staticfile)("img/uploading.gif")})),u.default.createElement("button",{disabled:this.props.isSubmitting,className:"b-new-message__button b-button b-button_fs_18",onClick:this.handleSubmitClick.bind(this)},this.props.isSubmitting?"Отправляется...":"Отправить"),u.default.createElement("div",{className:"b-new-message__file"},u.default.createElement("svg",{className:"b-new-message__icon",dangerouslySetInnerHTML:(0,_.svgContent)("#static--svg--camera")}),u.default.createElement("input",{className:"b-new-message__input",type:"file",title:"Выбрать фото",onChange:this.handlePhotoUpload.bind(this)})),u.default.createElement("div",{className:"b-new-message__file"},u.default.createElement("svg",{className:"b-new-message__icon",dangerouslySetInnerHTML:(0,_.svgContent)("#static--svg--paste")}),u.default.createElement("span",{className:"b-new-message__input",title:"Готовые ответы",onClick:this.handleTemplatesModalOpen.bind(this)})),u.default.createElement("div",{className:"b-new-message__file"},u.default.createElement("svg",{className:(0,g.default)("b-new-message__icon-heart2",{"b-new-message__icon-heart2_state_active":this.props.dialogIsImportant}),dangerouslySetInnerHTML:(0,_.svgContent)("#static--svg--heart2")}),u.default.createElement("span",{className:"b-new-message__input",title:this.props.dialogIsImportant?"Удалить из избранного":"Добавить в избранное",onClick:this.toggleThreadImportance.bind(this)})),u.default.createElement(f.default,{isOpen:this.props.isModalOpen,onRequestClose:this.onClose.bind(this),contentLabel:"Modal",className:"b-modal b-modal_maxw_300",overlayClassName:"b-modal__overlay"},u.default.createElement(v.default,i({eventStream:this.props.eventStream},this.props))))}}]),t}(u.default.Component);t.default=w}},[1214]);
//# sourceMappingURL=messages.67a06664fac65705fca1.js.map